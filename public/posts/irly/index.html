<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Creating a Website on a Hidden Network | Taylor's Blog</title>
<meta name=keywords content="programming,grpc,rust"><meta name=description content="After my last post on Creating a Networked Client to Power Centralized Insights, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running."><meta name=author content="Taylor Deckard"><link rel=canonical href=https://www.taylordeckard.me/blog/posts/irly/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.taylordeckard.me/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.taylordeckard.me/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.taylordeckard.me/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://www.taylordeckard.me/blog/apple-touch-icon.png><link rel=mask-icon href=https://www.taylordeckard.me/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.taylordeckard.me/blog/posts/irly/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://www.taylordeckard.me/blog/posts/irly/"><meta property="og:site_name" content="Taylor's Blog"><meta property="og:title" content="Creating a Website on a Hidden Network"><meta property="og:description" content="After my last post on Creating a Networked Client to Power Centralized Insights, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-11T00:00:00+00:00"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Grpc"><meta property="article:tag" content="Rust"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating a Website on a Hidden Network"><meta name=twitter:description content="After my last post on Creating a Networked Client to Power Centralized Insights, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.taylordeckard.me/blog/posts/"},{"@type":"ListItem","position":2,"name":"Creating a Website on a Hidden Network","item":"https://www.taylordeckard.me/blog/posts/irly/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Creating a Website on a Hidden Network","name":"Creating a Website on a Hidden Network","description":"After my last post on Creating a Networked Client to Power Centralized Insights, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running.","keywords":["programming","grpc","rust"],"articleBody":"After my last post on Creating a Networked Client to Power Centralized Insights, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running.This would ensure that to be a participant in the network, you are also contributing to the network.\nThe Design sequenceDiagram actor User participant Client A participant Hub participant Client B Client B-\u003e\u003eHub: Connects via gRPC stream User-\u003e\u003eClient A: Runs client program Client A-\u003e\u003eHub: Connects via gRPC stream User-\u003e\u003eClient A: Requests website (http://localhost:8080) Client A-\u003e\u003eHub: Calls gRPC to retrieve website data Hub-\u003e\u003eClient A: Responds with website data Client A-\u003e\u003eUser: Serves website User-\u003e\u003eClient A: Requests info from Client B Client A-\u003e\u003eHub: Sends gRPC request Hub-\u003e\u003eClient B: Notifies via gRPC stream Client B-\u003e\u003eHub: Responds with data Hub-\u003e\u003eClient A: Responds with data Client A-\u003e\u003eUser: Serves data Now this may look a bit complicated so let’s break it down. The user runs a client program on their machine. This client connects to the hub and serves a website on http://localhost:8080. The user can then request data from other clients on the network. The client program will make a gRPC call to the hub, which will then notify the other client to send the data. The hub will then send the data back to the client program, which will serve it to the user.\nOk, so how do I implement this?\ngRPC and Rust First, let’s create a new Rust project. I am calling it irly because I am not very creative with names. (Side note: I typed in “I am calling it irly because \" and copilot suggested the rest. 😀)\ncargo new irly Before writing any code in Rust though, I need to make a proto definition for gRPC.\nsyntax = \"proto3\"; package irly.v1; service Irly { rpc GetFile (GetFileRequest) returns (GetFileResponse); } message GetFileRequest { string file_path = 1; } message GetFileResponse { string file_path = 1; bytes file_content = 2; } This proto file defines a service called Irly with a single method GetFile. This method takes a GetFileRequest and returns a GetFileResponse. The request contains a file_path and the response contains the file_path and the file_content. The idea is to imitate a file server in gRPC.\nTonic To set up a gRPC server in Rust, I used tonic. To install the dependencies, I first installed cargo-edit.\ncargo install cargo-edit This allows me to add dependencies to my Cargo.toml file with the cargo add command.\ncargo add async-trait # prost serializes and deserializes protobuf cargo add prost # tokio is needed for async cargo add tokio -F full # tonic is the gRPC library with gzip support cargo add tonic -F gzip # tonic-reflection is needed for reflection cargo add tonic-reflection # tonic-build is needed to compile the proto cargo add --build tonic-build Next, I have to add a step to the build so that the protobuf definition is compiled into Rust code. Fortunately, placing a file named build.rs in the root of a package will cause Cargo to compile that script and execute it just before building the package.\nuse std::error::Error; use std::{env, path::PathBuf}; fn main() -\u003e Result\u003c(), Box\u003cdyn Error\u003e\u003e { // Cargo sets OUT_DIR environment variable to the output directory let out_dir = PathBuf::from(env::var(\"OUT_DIR\").unwrap()); // Output the file descriptor for reflection tonic_build::configure() .file_descriptor_set_path(out_dir.join(\"irly_descriptor.bin\")) .compile_protos(\u0026[\"proto/irly/v1/files.proto\"], \u0026[\"proto\"])?; // Compile the protobuf tonic_build::compile_protos(\"proto/irly/v1/files.proto\")?; Ok(()) } Next, I will setup the server. In src/main.rs I will add the following code.\n// Create a module for the proto definition mod proto { tonic::include_proto!(\"irly.v1\"); // Include the file descriptor set pub(crate) const FILE_DESCRIPTOR_SET: \u0026[u8] = tonic::include_file_descriptor_set!(\"irly_descriptor\"); } use proto::irly_server::Irly; // Implement the service #[derive(Debug, Default)] struct IrlyService {} #[tonic::async_trait] impl Irly for IrlyService { // Implement the GetFile method defined in the proto async fn get_file( \u0026self, request: tonic::Request\u003cproto::GetFileRequest\u003e, ) -\u003e Result\u003ctonic::Response\u003cproto::GetFileResponse\u003e, tonic::Status\u003e { let input = request.get_ref(); if input.file_path.is_empty() { return Err(tonic::Status::invalid_argument(\"file_path is empty\")); } println!(\"Request for file: {:?}\", \u0026input.file_path); let response = proto::GetFileResponse { file_path: input.file_path.clone(), file_content: String::from(\"content\"), }; Ok(tonic::Response::new(response)) } } #[tokio::main] async fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e { let addr = \"[::1]:50051\".parse()?; let irly = IrlyService::default(); // Create a reflection service // (This is so clients do not need to know the proto definition) let service = tonic_reflection::server::Builder::configure() .register_encoded_file_descriptor_set(proto::FILE_DESCRIPTOR_SET) .build_v1()?; // Create the server tonic::transport::Server::builder() .add_service(service) .add_service(proto::irly_server::IrlyServer::new(irly)) .serve(addr) .await?; Ok(()) } This code sets up a gRPC server that listens on port 50051 and implements the GetFile method. The method simply returns a string “content” for any file path requested. I can manually call this method on command-line using the grpcurl tool.\ngrpcurl -plaintext \\ -d '{\"file_path\": \"test.html\"}' \\ 'localhost:50051' irly.v1.Irly.GetFile Response:\n{ \"file_path\": \"test.html\", \"file_content\": \"content\" } The Client Now, I need to create a client that can connect to the server and request a file. I will create a new file src/client.rs and add the following code. In cargo.toml, I will add the following line to include the client in the build.\n[[bin]] name = \"hub\" path = \"src/hub.rs\" [[bin]] name = \"client\" path = \"src/client.rs\" With this I can run the different programs using cargo run --bin .\nTo run a quick test before implementing the desired functionality, I will add the following code to src/client.rs.\nmod proto { tonic::include_proto!(\"irly.v1\"); } // Use the Client instead of the Server use proto::irly_client::IrlyClient; #[tokio::main] async fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e { let addr = \"http://localhost:50051\"; let mut client = IrlyClient::connect(addr).await?; let req = proto::GetFileRequest { file_path: \"file.txt\".to_string(), }; let request = tonic::Request::new(req); let response = client.get_file(request).await?; println!(\"Response: {:?}\", response.get_ref().file_content); Ok(()) } Now, to run the gRPC server:\ncargo run --bin hub Then (in another shell) to run the client:\ncargo run --bin client Result:\nResponse: \"content\" Serving a Website Ok, so the server is working and the client can request a file. Now I need to actually have the hub respond with file contents. Later, I might do something more interesting like serve an Angular or React app, but for now I’ll create a simple index.html file in a new directory called public.\n\u003c!DOCTYPE html\u003e \u003chtml lang=\"en\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e \u003ctitle\u003eirly\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003ch1\u003eirly\u003c/h1\u003e \u003cp\u003eWelcome to irly. You have successfully joined the network!\u003c/p\u003e \u003c/body\u003e \u003c/html\u003e When a client requests the index.html file, the hub should respond with the contents of this file. To do this, I will read the file and return the contents in the response.\nFirst, I’ll add a function to read an file from disk. I created a new file src/file_reader.rs and added the following code.\nuse tokio::fs; use std::path::Path; const PUBLIC_PATH: \u0026'static str = \"./public/\"; pub async fn read(path: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e, Box\u003cdyn std::error::Error\u003e\u003e { let public_path = Path::new(PUBLIC_PATH).join(path); let bytes = match fs::read(public_path).await { Ok(bytes) =\u003e bytes, Err(e) =\u003e { eprintln!(\"Error reading file: {e:?}\"); return Err(Box::new(e)); }, }; Ok(bytes) } Then in hub.rs, I’ll add a few lines\nmod file_reader; 1#[tonic::async_trait] 2impl Irly for IrlyService { 3 async fn get_file( 4 \u0026self, 5 request: tonic::Request\u003cproto::GetFileRequest\u003e, 6 ) -\u003e Result\u003ctonic::Response\u003cproto::GetFileResponse\u003e, tonic::Status\u003e { 7 let input = request.get_ref(); 8 9 if input.file_path.is_empty() { 10 return Err(tonic::Status::invalid_argument(\"file_path is empty\")); 11 } 12 13 println!(\"Request for file: {:?}\", \u0026input.file_path); 14 15 let file = file_reader::read(\u0026input.file_path).await; 16 17 if file.is_err() { 18 return Err(tonic::Status::not_found(\"file not found\")); 19 } 20 21 let mut file_path = input.file_path.clone(); 22 // Remove leading slash from path 23 if input.file_path.starts_with('/') { 24 file_path.remove(0); 25 } 26 // Default a request for \"/\" to index.html 27 if \u0026input.file_path == \"/\" { 28 file_path = \"index.html\".to_string(); 29 } 30 31 let response = proto::GetFileResponse { 32 file_path: file_path.clone(), 33 file_content: file.unwrap(), 34 }; 35 36 Ok(tonic::Response::new(response)) 37 } 38} First, I added the module definition for the file reader. Then (starting on line 15) I added a call to the file reader in the get_file method. If the file is not found, I return a not_found status. Otherwise, I return the file contents in the response.\nIf I update the client to request index.html, I should see the contents of the file in the response.\nResult:\n% cargo run --bin client Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.20s Running `target/debug/client` Response: \"\u003c!DOCTYPE html\u003e\\n\\n\\n \\n \\n irly\\n\\n\\n irly\\n Welcome to irly. You have successfully joined the network!\n\\n\\n\\n\" Back to the Client Now that the hub is serving the website, I need to update the client to serve the website. I will use warp again since it worked well in the previous post.\nFirst, I will add the warp dependency to the client.\ncargo add warp Then, I will update the main function in src/client.rs to serve the website.\n1#[tokio::main] 2async fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e { 3 let proxy_route = warp::path::full().and(warp::get()).and_then(web_handler); 4 5 let routes = proxy_route.recover(handle_rejection); 6 7 warp::serve(routes).run(([127, 0, 0, 1], 8080)).await; 8 9 Ok(()) 10} Notice on line 3, I am registering a route that will call the web_handler function whenever any route is requested. The full path is passed into the web_handler function as a FullPath struct. The path can be extracted and then forwarded to the hub to request the file contents.\n1async fn web_handler(path: warp::path::FullPath) -\u003e Result\u003cimpl warp::Reply, warp::Rejection\u003e { 2 let addr = \"http://localhost:50051\"; 3 // Connect to the hub, accept Gzip, and set max message sizes 4 let mut client = IrlyClient::connect(addr) 5 .await 6 .unwrap() 7 .accept_compressed(CompressionEncoding::Gzip) 8 .max_decoding_message_size(256 * 1024 * 1024) 9 .max_encoding_message_size(256 * 1024 * 1024); 10 11 let response = match request_file(\u0026mut client, path.as_str()).await { 12 Ok(response) =\u003e response, 13 Err(e) =\u003e { 14 eprintln!(\"Error: {e:?}\"); 15 return Err(warp::reject::not_found()); 16 } 17 }; 18 19 let res_ref = response.get_ref(); 20 21 Ok(warp::reply::with_header( 22 res_ref.file_content.clone(), 23 \"content-type\", 24 mime_guess::from_path(\u0026res_ref.file_path) 25 .first_or_octet_stream() 26 .to_string(), 27 )) 28} This creates a gRPC client and passes it, along with the path, to the request_file function. If the file is not found, a not_found rejection is returned. Otherwise, the file contents are returned with the appropriate content type (using mime_guess for this.)\nThe request_file function is defined as follows:\nasync fn request_file( client: \u0026mut IrlyClient\u003ctonic::transport::channel::Channel\u003e, path: \u0026str, ) -\u003e Result\u003ctonic::Response\u003cproto::GetFileResponse\u003e, Box\u003cdyn std::error::Error\u003e\u003e { let req = proto::GetFileRequest { file_path: path.to_string(), }; let request = tonic::Request::new(req); let response = match client.get_file(request).await { Ok(response) =\u003e response, Err(e) =\u003e return Err(Box::new(e)), }; Ok(response) } This function creates a GetFileRequest and sends it to the hub. If the request is successful, the response is returned. Otherwise, an error is returned.\nDoes it work? After spinning up the hub and the client again, here are the results of navigating to http://localhost:8080 in the browser.\nSo yes, it works! The client is serving the website from the hub. This is a simple example, but it demonstrates how a decentralized website could be created using gRPC and Rust. I think this could be a bit more interesting if the hub can facilitate peer discovery and the transfer of data between clients. That might be a topic for another post. 😄\nCheck out the code for this post on GitHub.\n","wordCount":"1860","inLanguage":"en","datePublished":"2024-11-11T00:00:00Z","dateModified":"2024-11-11T00:00:00Z","author":{"@type":"Person","name":"Taylor Deckard"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taylordeckard.me/blog/posts/irly/"},"publisher":{"@type":"Organization","name":"Taylor's Blog","logo":{"@type":"ImageObject","url":"https://www.taylordeckard.me/blog/favicon.ico"}}}</script><link rel=stylesheet href=/blog/styles.css></link></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.taylordeckard.me/blog/ accesskey=h title="Blog (Alt + H)">Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.taylordeckard.me/blog/archives title=Archives><span>Archives</span></a></li><li><a href=https://www.taylordeckard.me/blog/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://www.taylordeckard.me/blog/tags title=Tags><span>Tags</span></a></li><li><a href=https://taylordeckard.me title=taylordeckard.me><span>taylordeckard.me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.taylordeckard.me/blog/>Home</a>&nbsp;»&nbsp;<a href=https://www.taylordeckard.me/blog/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Creating a Website on a Hidden Network</h1><div class=post-meta><span title='2024-11-11 00:00:00 +0000 UTC'>November 11, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Taylor Deckard&nbsp;|&nbsp;<a href=https://github.com/taylordeckard/blog/tree/main/content/posts/irly.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>After my last post on <a href=../distributed-dashboard>Creating a Networked Client to Power Centralized Insights</a>, I started to think about how I could use a similar design to create a decentralized website. Users could run their clients locally, store information on their own machines, and connect to other clients from the central hub. An interesting design choice, I thought, would be for the website to only be accessible from the local network when the client is running.This would ensure that to be a participant in the network, you are also contributing to the network.</p><h2 id=the-design>The Design<a hidden class=anchor aria-hidden=true href=#the-design>#</a></h2><pre class=mermaid>sequenceDiagram
    actor User
    participant Client A
    participant Hub
    participant Client B
    Client B->>Hub: Connects via gRPC stream
    User->>Client A: Runs client program
    Client A->>Hub: Connects via gRPC stream
    User->>Client A: Requests website (http://localhost:8080)
    Client A->>Hub: Calls gRPC to retrieve website data
    Hub->>Client A: Responds with website data
    Client A->>User: Serves website
    User->>Client A: Requests info from Client B
    Client A->>Hub: Sends gRPC request
    Hub->>Client B: Notifies via gRPC stream
    Client B->>Hub: Responds with data
    Hub->>Client A: Responds with data
    Client A->>User: Serves data
</pre><p>Now this may look a bit complicated so let&rsquo;s break it down. The user runs a client program on their machine. This client connects to the hub and serves a website on <code>http://localhost:8080</code>. The user can then request data from other clients on the network. The client program will make a <a href=https://grpc.io/>gRPC</a> call to the hub, which will then notify the other client to send the data. The hub will then send the data back to the client program, which will serve it to the user.</p><p>Ok, so how do I implement this?</p><h2 id=grpc-and-rust>gRPC and Rust<a hidden class=anchor aria-hidden=true href=#grpc-and-rust>#</a></h2><p>First, let&rsquo;s create a new Rust project. I am calling it <code>irly</code> because I am not very creative with names. (Side note: I typed in &ldquo;I am calling it <code>irly</code> because " and <a href=https://github.com/features/copilot>copilot</a> suggested the rest. 😀)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo new irly
</span></span></code></pre></div><p>Before writing any code in Rust though, I need to make a proto definition for gRPC.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>irly</span><span class=o>.</span><span class=n>v1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Irly</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>GetFile</span> <span class=p>(</span><span class=n>GetFileRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>GetFileResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>GetFileRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>file_path</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>GetFileResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>file_path</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>bytes</span> <span class=n>file_content</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>This proto file defines a service called <code>Irly</code> with a single method <code>GetFile</code>. This method takes a <code>GetFileRequest</code> and returns a <code>GetFileResponse</code>. The request contains a <code>file_path</code> and the response contains the <code>file_path</code> and the <code>file_content</code>. The idea is to imitate a file server in gRPC.</p><h2 id=tonic>Tonic<a hidden class=anchor aria-hidden=true href=#tonic>#</a></h2><p>To set up a gRPC server in Rust, I used <a href=https://github.com/hyperium/tonic>tonic</a>. To install the dependencies, I first installed cargo-edit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo install cargo-edit
</span></span></code></pre></div><p>This allows me to add dependencies to my <code>Cargo.toml</code> file with the <code>cargo add</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo add async-trait
</span></span><span class=line><span class=cl><span class=c1># prost serializes and deserializes protobuf</span>
</span></span><span class=line><span class=cl>cargo add prost
</span></span><span class=line><span class=cl><span class=c1># tokio is needed for async</span>
</span></span><span class=line><span class=cl>cargo add tokio -F full
</span></span><span class=line><span class=cl><span class=c1># tonic is the gRPC library with gzip support</span>
</span></span><span class=line><span class=cl>cargo add tonic -F gzip
</span></span><span class=line><span class=cl><span class=c1># tonic-reflection is needed for reflection</span>
</span></span><span class=line><span class=cl>cargo add tonic-reflection
</span></span><span class=line><span class=cl><span class=c1># tonic-build is needed to compile the proto</span>
</span></span><span class=line><span class=cl>cargo add --build tonic-build
</span></span></code></pre></div><p>Next, I have to add a step to the build so that the protobuf definition is compiled into Rust code. Fortunately, placing a file named <code>build.rs</code> in the root of a package will cause Cargo to compile that script and execute it just before building the package.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>path</span>::<span class=n>PathBuf</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Cargo sets OUT_DIR environment variable to the output directory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>out_dir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PathBuf</span>::<span class=n>from</span><span class=p>(</span><span class=n>env</span>::<span class=n>var</span><span class=p>(</span><span class=s>&#34;OUT_DIR&#34;</span><span class=p>).</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Output the file descriptor for reflection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>tonic_build</span>::<span class=n>configure</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>file_descriptor_set_path</span><span class=p>(</span><span class=n>out_dir</span><span class=p>.</span><span class=n>join</span><span class=p>(</span><span class=s>&#34;irly_descriptor.bin&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>compile_protos</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[</span><span class=s>&#34;proto/irly/v1/files.proto&#34;</span><span class=p>],</span><span class=w> </span><span class=o>&amp;</span><span class=p>[</span><span class=s>&#34;proto&#34;</span><span class=p>])</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Compile the protobuf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>tonic_build</span>::<span class=n>compile_protos</span><span class=p>(</span><span class=s>&#34;proto/irly/v1/files.proto&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Next, I will setup the server. In <code>src/main.rs</code> I will add the following code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// Create a module for the proto definition
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>mod</span> <span class=nn>proto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tonic</span>::<span class=fm>include_proto!</span><span class=p>(</span><span class=s>&#34;irly.v1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Include the file descriptor set
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=no>FILE_DESCRIPTOR_SET</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tonic</span>::<span class=fm>include_file_descriptor_set!</span><span class=p>(</span><span class=s>&#34;irly_descriptor&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>proto</span>::<span class=n>irly_server</span>::<span class=n>Irly</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Implement the service
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[derive(Debug, Default)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>IrlyService</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tonic::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Irly</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>IrlyService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Implement the GetFile method defined in the proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_file</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span>: <span class=nc>tonic</span>::<span class=n>Request</span><span class=o>&lt;</span><span class=n>proto</span>::<span class=n>GetFileRequest</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>tonic</span>::<span class=n>Response</span><span class=o>&lt;</span><span class=n>proto</span>::<span class=n>GetFileResponse</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>tonic</span>::<span class=n>Status</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=n>get_ref</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>tonic</span>::<span class=n>Status</span>::<span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;file_path is empty&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Request for file: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proto</span>::<span class=n>GetFileResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>file_path</span>: <span class=nc>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>file_content</span>: <span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=s>&#34;content&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>tonic</span>::<span class=n>Response</span>::<span class=n>new</span><span class=p>(</span><span class=n>response</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;[::1]:50051&#34;</span><span class=p>.</span><span class=n>parse</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>irly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IrlyService</span>::<span class=n>default</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create a reflection service
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// (This is so clients do not need to know the proto definition)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tonic_reflection</span>::<span class=n>server</span>::<span class=n>Builder</span>::<span class=n>configure</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>register_encoded_file_descriptor_set</span><span class=p>(</span><span class=n>proto</span>::<span class=no>FILE_DESCRIPTOR_SET</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>build_v1</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create the server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>tonic</span>::<span class=n>transport</span>::<span class=n>Server</span>::<span class=n>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_service</span><span class=p>(</span><span class=n>service</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>add_service</span><span class=p>(</span><span class=n>proto</span>::<span class=n>irly_server</span>::<span class=n>IrlyServer</span>::<span class=n>new</span><span class=p>(</span><span class=n>irly</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>serve</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This code sets up a gRPC server that listens on port <code>50051</code> and implements the <code>GetFile</code> method. The method simply returns a string &ldquo;content&rdquo; for any file path requested. I can manually call this method on command-line using the <a href="https://github.com/fullstorydev/grpcurl?tab=readme-ov-file#installation">grpcurl</a> tool.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>grpcurl -plaintext <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -d <span class=s1>&#39;{&#34;file_path&#34;: &#34;test.html&#34;}&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>&#39;localhost:50051&#39;</span> irly.v1.Irly.GetFile
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;file_path&#34;</span><span class=p>:</span> <span class=s2>&#34;test.html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;file_content&#34;</span><span class=p>:</span> <span class=s2>&#34;content&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=the-client>The Client<a hidden class=anchor aria-hidden=true href=#the-client>#</a></h2><p>Now, I need to create a client that can connect to the server and request a file. I will create a new file <code>src/client.rs</code> and add the following code. In <code>cargo.toml</code>, I will add the following line to include the client in the build.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>bin</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;hub&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>path</span> <span class=p>=</span> <span class=s2>&#34;src/hub.rs&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[[</span><span class=nx>bin</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;client&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>path</span> <span class=p>=</span> <span class=s2>&#34;src/client.rs&#34;</span>
</span></span></code></pre></div><p>With this I can run the different programs using <code>cargo run --bin &lt;client|hub></code>.</p><p>To run a quick test before implementing the desired functionality, I will add the following code to <code>src/client.rs</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>mod</span> <span class=nn>proto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tonic</span>::<span class=fm>include_proto!</span><span class=p>(</span><span class=s>&#34;irly.v1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Use the Client instead of the Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>use</span><span class=w> </span><span class=n>proto</span>::<span class=n>irly_client</span>::<span class=n>IrlyClient</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;http://localhost:50051&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IrlyClient</span>::<span class=n>connect</span><span class=p>(</span><span class=n>addr</span><span class=p>).</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proto</span>::<span class=n>GetFileRequest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>file_path</span>: <span class=s>&#34;file.txt&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tonic</span>::<span class=n>Request</span>::<span class=n>new</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>get_file</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Response: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=n>get_ref</span><span class=p>().</span><span class=n>file_content</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Now, to run the gRPC server:</p><pre tabindex=0><code>cargo run --bin hub
</code></pre><p>Then (in another shell) to run the client:</p><pre tabindex=0><code>cargo run --bin client
</code></pre><p>Result:</p><pre tabindex=0><code>Response: &#34;content&#34;
</code></pre><h2 id=serving-a-website>Serving a Website<a hidden class=anchor aria-hidden=true href=#serving-a-website>#</a></h2><p>Ok, so the server is working and the client can request a file. Now I need to actually have the hub respond with file contents. Later, I might do something more interesting like serve an Angular or React app, but for now I&rsquo;ll create a simple index.html file in a new directory called <code>public</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>irly<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>irly<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Welcome to irly. You have successfully joined the network!<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>When a client requests the index.html file, the hub should respond with the contents of this file. To do this, I will read the file and return the contents in the response.</p><p>First, I&rsquo;ll add a function to read an file from disk. I created a new file <code>src/file_reader.rs</code> and added the following code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>tokio</span>::<span class=n>fs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>path</span>::<span class=n>Path</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>const</span><span class=w> </span><span class=no>PUBLIC_PATH</span>: <span class=kp>&amp;</span><span class=nb>&#39;static</span> <span class=kt>str</span> <span class=o>=</span><span class=w> </span><span class=s>&#34;./public/&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>read</span><span class=p>(</span><span class=n>path</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>public_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Path</span>::<span class=n>new</span><span class=p>(</span><span class=no>PUBLIC_PATH</span><span class=p>).</span><span class=n>join</span><span class=p>(</span><span class=n>path</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>fs</span>::<span class=n>read</span><span class=p>(</span><span class=n>public_path</span><span class=p>).</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>bytes</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>bytes</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&#34;Error reading file: </span><span class=si>{e:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=nb>Box</span>::<span class=n>new</span><span class=p>(</span><span class=n>e</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>bytes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Then in <code>hub.rs</code>, I&rsquo;ll add a few lines</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>mod</span> <span class=nn>file_reader</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln> 1</span><span class=cl><span class=cp>#[tonic::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Irly</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>IrlyService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_file</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>        </span><span class=n>request</span>: <span class=nc>tonic</span>::<span class=n>Request</span><span class=o>&lt;</span><span class=n>proto</span>::<span class=n>GetFileRequest</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>tonic</span>::<span class=n>Response</span><span class=o>&lt;</span><span class=n>proto</span>::<span class=n>GetFileResponse</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>tonic</span>::<span class=n>Status</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=n>get_ref</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>.</span><span class=n>is_empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>tonic</span>::<span class=n>Status</span>::<span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;file_path is empty&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Request for file: </span><span class=si>{:?}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file_reader</span>::<span class=n>read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>file</span><span class=p>.</span><span class=n>is_err</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>tonic</span>::<span class=n>Status</span>::<span class=n>not_found</span><span class=p>(</span><span class=s>&#34;file not found&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>file_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>        </span><span class=c1>// Remove leading slash from path
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=c1></span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=p>.</span><span class=n>starts_with</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>            </span><span class=n>file_path</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>        </span><span class=c1>// Default a request for &#34;/&#34; to index.html
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=c1></span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=o>&amp;</span><span class=n>input</span><span class=p>.</span><span class=n>file_path</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;/&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>            </span><span class=n>file_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;index.html&#34;</span><span class=p>.</span><span class=n>to_string</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proto</span>::<span class=n>GetFileResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>            </span><span class=n>file_path</span>: <span class=nc>file_path</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>            </span><span class=n>file_content</span>: <span class=nc>file</span><span class=p>.</span><span class=n>unwrap</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>tonic</span>::<span class=n>Response</span>::<span class=n>new</span><span class=p>(</span><span class=n>response</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>First, I added the module definition for the file reader. Then (starting on line 15) I added a call to the file reader in the <code>get_file</code> method. If the file is not found, I return a <code>not_found</code> status. Otherwise, I return the file contents in the response.</p><p>If I update the client to request <code>index.html</code>, I should see the contents of the file in the response.</p><p>Result:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>% cargo run --bin client
</span></span><span class=line><span class=cl>    Finished <span class=sb>`</span>dev<span class=sb>`</span> profile <span class=o>[</span>unoptimized + debuginfo<span class=o>]</span> target<span class=o>(</span>s<span class=o>)</span> in 0.20s
</span></span><span class=line><span class=cl>         Running <span class=sb>`</span>target/debug/client<span class=sb>`</span>
</span></span><span class=line><span class=cl>         Response: <span class=s2>&#34;&lt;!DOCTYPE html&gt;\n&lt;html lang=\&#34;en\&#34;&gt;\n&lt;head&gt;\n    &lt;meta charset=\&#34;UTF-8\&#34;&gt;\n    &lt;meta name=\&#34;viewport\&#34; content=\&#34;width=device-width, initial-scale=1.0\&#34;&gt;\n    &lt;title&gt;irly&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n    &lt;h1&gt;irly&lt;/h1&gt;\n    &lt;p&gt;Welcome to irly. You have successfully joined the network!&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&#34;</span>
</span></span></code></pre></div><h2 id=back-to-the-client>Back to the Client<a hidden class=anchor aria-hidden=true href=#back-to-the-client>#</a></h2><p><img alt="Back to the Client" loading=lazy src=/blog/images/irly/b2tf.gif></p><p>Now that the hub is serving the website, I need to update the client to serve the website. I will use <a href=https://github.com/seanmonstar/warp>warp</a> again since it worked well in the <a href=../distributed-dashboard>previous post</a>.</p><p>First, I will add the warp dependency to the client.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo add warp
</span></span></code></pre></div><p>Then, I will update the main function in <code>src/client.rs</code> to serve the website.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln> 1</span><span class=cl><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>proxy_route</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>warp</span>::<span class=n>path</span>::<span class=n>full</span><span class=p>().</span><span class=n>and</span><span class=p>(</span><span class=n>warp</span>::<span class=n>get</span><span class=p>()).</span><span class=n>and_then</span><span class=p>(</span><span class=n>web_handler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>routes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proxy_route</span><span class=p>.</span><span class=n>recover</span><span class=p>(</span><span class=n>handle_rejection</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=n>warp</span>::<span class=n>serve</span><span class=p>(</span><span class=n>routes</span><span class=p>).</span><span class=n>run</span><span class=p>(([</span><span class=mi>127</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=mi>8080</span><span class=p>)).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Notice on line 3, I am registering a route that will call the <code>web_handler</code> function whenever any route is requested. The full path is passed into the <code>web_handler</code> function as a FullPath struct. The path can be extracted and then forwarded to the hub to request the file contents.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln> 1</span><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>web_handler</span><span class=p>(</span><span class=n>path</span>: <span class=nc>warp</span>::<span class=n>path</span>::<span class=n>FullPath</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=k>impl</span><span class=w> </span><span class=n>warp</span>::<span class=n>Reply</span><span class=p>,</span><span class=w> </span><span class=n>warp</span>::<span class=n>Rejection</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;http://localhost:50051&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=c1>// Connect to the hub, accept Gzip, and set max message sizes
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>client</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IrlyClient</span>::<span class=n>connect</span><span class=p>(</span><span class=n>addr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>accept_compressed</span><span class=p>(</span><span class=n>CompressionEncoding</span>::<span class=n>Gzip</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>max_decoding_message_size</span><span class=p>(</span><span class=mi>256</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>max_encoding_message_size</span><span class=p>(</span><span class=mi>256</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>request_file</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=n>as_str</span><span class=p>()).</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&#34;Error: </span><span class=si>{e:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>warp</span>::<span class=n>reject</span>::<span class=n>not_found</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>res_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>response</span><span class=p>.</span><span class=n>get_ref</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>warp</span>::<span class=n>reply</span>::<span class=n>with_header</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>        </span><span class=n>res_ref</span><span class=p>.</span><span class=n>file_content</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>        </span><span class=s>&#34;content-type&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>        </span><span class=n>mime_guess</span>::<span class=n>from_path</span><span class=p>(</span><span class=o>&amp;</span><span class=n>res_ref</span><span class=p>.</span><span class=n>file_path</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>first_or_octet_stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>    </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This creates a gRPC client and passes it, along with the path, to the <code>request_file</code> function. If the file is not found, a <code>not_found</code> rejection is returned. Otherwise, the file contents are returned with the appropriate content type (using <a href=https://docs.rs/mime_guess/latest/mime_guess/>mime_guess</a> for this.)</p><p>The <code>request_file</code> function is defined as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_file</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>client</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>IrlyClient</span><span class=o>&lt;</span><span class=n>tonic</span>::<span class=n>transport</span>::<span class=n>channel</span>::<span class=n>Channel</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>tonic</span>::<span class=n>Response</span><span class=o>&lt;</span><span class=n>proto</span>::<span class=n>GetFileResponse</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=nb>Box</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>std</span>::<span class=n>error</span>::<span class=n>Error</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>proto</span>::<span class=n>GetFileRequest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>file_path</span>: <span class=nc>path</span><span class=p>.</span><span class=n>to_string</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tonic</span>::<span class=n>Request</span>::<span class=n>new</span><span class=p>(</span><span class=n>req</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>client</span><span class=p>.</span><span class=n>get_file</span><span class=p>(</span><span class=n>request</span><span class=p>).</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>response</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>response</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=nb>Box</span>::<span class=n>new</span><span class=p>(</span><span class=n>e</span><span class=p>)),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>response</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This function creates a <code>GetFileRequest</code> and sends it to the hub. If the request is successful, the response is returned. Otherwise, an error is returned.</p><h2 id=does-it-work>Does it work?<a hidden class=anchor aria-hidden=true href=#does-it-work>#</a></h2><p>After spinning up the hub and the client again, here are the results of navigating to http://localhost:8080 in the browser.</p><p><img alt="irly results" loading=lazy src=/blog/images/irly/irly_results.png></p><p>So yes, it works! The client is serving the website from the hub. This is a simple example, but it demonstrates how a decentralized website could be created using gRPC and Rust. I think this could be a bit more interesting if the hub can facilitate peer discovery and the transfer of data between clients. That might be a topic for another post. 😄</p><p>Check out the code for this post on <a href=https://github.com/taylordeckard/irly>GitHub</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.taylordeckard.me/blog/tags/programming/>Programming</a></li><li><a href=https://www.taylordeckard.me/blog/tags/grpc/>Grpc</a></li><li><a href=https://www.taylordeckard.me/blog/tags/rust/>Rust</a></li></ul><nav class=paginav><a class=prev href=https://www.taylordeckard.me/blog/posts/vimparq/><span class=title>« Prev</span><br><span>Creating a Vim Plugin to Edit Parquet Files</span>
</a><a class=next href=https://www.taylordeckard.me/blog/posts/distributed-dashboard/><span class=title>Next »</span><br><span>Distributed Dashboard: Creating a Networked Client to Power Centralized Insights</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></script><script type=module>
		import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
		mermaid.initialize({ startOnLoad: true });
	  </script></body></html>