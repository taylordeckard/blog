<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Bourbon Search pt. 1: Scraper | Taylor's Blog</title><meta name=keywords content="programming,node.js,typescript,graphql,mongodb,next.js,react"><meta name=description content="A series that discusses building a Whiskey Shop Search with Typescript, MongoDB, GraphQL and Next.js"><meta name=author content="Taylor Deckard"><link rel=canonical href=https://www.taylordeckard.me/blog/posts/bourbon/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/blog/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.taylordeckard.me/blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.taylordeckard.me/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.taylordeckard.me/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://www.taylordeckard.me/blog/apple-touch-icon.png><link rel=mask-icon href=https://www.taylordeckard.me/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Bourbon Search pt. 1: Scraper"><meta property="og:description" content="A series that discusses building a Whiskey Shop Search with Typescript, MongoDB, GraphQL and Next.js"><meta property="og:type" content="article"><meta property="og:url" content="https://www.taylordeckard.me/blog/posts/bourbon/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-11T00:00:00+00:00"><meta property="og:site_name" content="Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bourbon Search pt. 1: Scraper"><meta name=twitter:description content="A series that discusses building a Whiskey Shop Search with Typescript, MongoDB, GraphQL and Next.js"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.taylordeckard.me/blog/posts/"},{"@type":"ListItem","position":3,"name":"Bourbon Search pt. 1: Scraper","item":"https://www.taylordeckard.me/blog/posts/bourbon/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Bourbon Search pt. 1: Scraper","name":"Bourbon Search pt. 1: Scraper","description":"A series that discusses building a Whiskey Shop Search with Typescript, MongoDB, GraphQL and Next.js","keywords":["programming","node.js","typescript","graphql","mongodb","next.js","react"],"articleBody":"Today I’m admitting a guilty pleasure: Bourbon. I read reviews online, hunt for rare bottles, and shell out (maybe a little too much) cash sometimes on interesting things I find. Bourbon has definitely experienced a surge in popularity over the past few years, particularly in the United States. In fact, bourbon has become so popular that the industry is struggling to keep up with demand. The reasons for bourbon’s rise in popularity are varied, but some contributing factors include the rise of the craft cocktail movement, a growing interest in American-made products, and an increased focus on artisanal and small-batch products.\nOne of the consequences of bourbon’s popularity is that certain bottles have become highly sought after, and they can command high prices on the secondary market. This is particularly true for limited edition or rare bottlings, as well as bottles that have garnered high ratings from influential critics.\nThe high demand for these bottles has created a secondary market where collectors and enthusiasts buy and sell bottles at prices far above their retail value. In some cases, these bottles can fetch thousands of dollars, and the prices can be driven up even further by auction houses or online bidding platforms.\nSome of the most sought-after bourbons include the Pappy Van Winkle line, which is produced in limited quantities and has a cult following among bourbon aficionados. Other popular bourbons include releases from Buffalo Trace’s Antique Collection, such as the George T. Stagg and William Larue Weller bottlings. These bottles can be difficult to find at retail, and some enthusiasts are willing to pay a premium to get their hands on them.\nBesides being a fan of whiskey, I’m fascinated by the sudden and explosive growth of markets for popular items. It’s intriguing to see how a previously niche product can become a mainstream sensation or a little-known brand can suddenly dominate the market. The study of these sudden market shifts is endlessly captivating, offering insights into the dynamism and unpredictability of consumer behavior and the economy.\nThanks to ChatGPT for helping me out with the filler text above. Now let’s talk about programming…\nWeb Scraper I wanted an easier way to search for bourbon online. I have a few stores I like to browse and there are so many products that I just don’t care about. So I made a web scraper with typescript…\nI wanted to design something extensible, since I knew there were several websites I wanted to scrape. For that reason, I started with a Scraper base class. Generally the scraping process requires three basic steps:\nScrape the total number of products you want to pull from the site. Paginate through the entire list of products and store the product information in memory. Save the data in a database. Incorporating this idea into the base Scraper class, I started with a simple scrape method:\nexport class Scraper { public async scrape(): Promise\u003cvoid\u003e { await this._db.connect(); await this._scrapeAllPages(); await this._storeData(); this._db.client.close(); } } I created a separate class to manage the DB connection:\nimport { MongoClient } from \"mongodb\"; export class DB { public client: MongoClient; constructor() { // All credentials are set via environment variables const user = process.env.DB_USER; const password = process.env.DB_PASSWORD; const host = process.env.DB_HOST; const port = process.env.DB_PORT; const url = `mongodb://${user}:${password}@${host}:${port}?retryWrites=true\u0026w=majority`; this.client = new MongoClient(url); } public connect() { /** * This will return a promise that resolves after the connection * is made. If the client is already connected, the promise * immediately resolves. */ return this.client.connect(); } } Then imported it into the Scraper.\nimport { DB } from \"./db\"; export class Scraper { _db: DB; constructor() { /** * The scrapers will be executed in parallel, each within a worker. * For this reason each scraper will use a new DB class with separate * connections. */ this._db = new DB(); } public async scrape(): Promise\u003cvoid\u003e { await this._db.connect(); await this._scrapeAllPages(); await this._storeData(); this._db.client.close(); } } Ok, good. The database connection is in place. Now to implement step #1.\nexport class Scraper { ... async _getTotal(): Promise\u003cnumber\u003e { /** * This should return the total number products to scrape * from the website. This implementation will likely vary for * each website, so it just resolves a promise in the base class * and the child classes will override. */ return Promise.resolve(0); } async _scrapeAllPages() { /** * The first step is to get the number of products to scrape */ const totalProducts = await this._getTotal(); } ... } Step 2 contains the bulk of the work.\nexport class Scraper { _totalPages = 0; _productsPerPage = 20; _website = \"\"; ... async _scrapeAllPages() { const totalProducts = await this._getTotal(); /** * Add _totalPages and _productsPerPage as protected class variables * to be set by the child classes. */ this._totalPages = Math.ceil(totalProducts / this._productsPerPage); let currentPage = 1; while (currentPage \u003c= this._totalPages) { /** * Since this is running in a worker, the next line reports progress * to the parent process. */ parentPort?.postMessage({ current: currentPage, scraper: this._website, total: this._totalPages, }); /** * Fetch the webpage, convert text to json, and parse the response. * These are methods that can be overridden by the child classes. */ this._parseResponse( this._convertTextToJson(await this._fetchUrl(currentPage)) ); currentPage += 1; } } ... } Using the total number of products along with the number of products per page, the total pages are calculated. Then, each page is queried with the _fetchUrl method, which looks like this:\nexport class Scraper { ... _pageKey = \"page\"; _queryParams: URLSearchParams = new URLSearchParams(); _url = \"\"; ... _buildUrl(page: number): string { /** * Sets the \"page\" query param and adds the query params to the * website URL. */ const url = new URL(this._url); const queryParams = new URLSearchParams(this._queryParams); /** * Note: The _pageKey is used in case a site uses a different * name for the \"page\" param, like \"p\" for instance. */ queryParams.set(this._pageKey, String(page)); url.search = queryParams.toString(); return url.toString(); } async _fetchUrl(page: number): Promise\u003cstring\u003e { /** * Call the native fetch method to get a page of data. Returns * text output (html) to be parsed. Child classes that query * an API instead of a webpage can override this method to return * another format such as json. */ const response = await fetch(this._buildUrl(page)); const text = await response.text(); return text; } ... } The fetched page needs to be converted to json (in some cases) and parsed. The base class defines these methods to handle that:\nexport class Scraper { ... _convertTextToJson(response: string): any { try { return JSON.parse(response); } catch (e) { console.error(`Failed to parse json for ${this._website}`); return {}; } } _parseResponse(response: any): void { // Store products in this._data here (implemented in child class) } ... } The above _convertTextToJson method will only work if the response content is in json form. One of the child classes overrides that method like this, for instance:\nexport class Scraper { ... _convertTextToJson(response: string): any { const $ = cheerio.load(response); return $(\".main_box\") .filter((idx, elem) =\u003e !$(elem).html()?.includes(\"sold-out\")) .map((idx, elem) =\u003e ({ handle: $(elem).find(\"h5 a\").attr(\"href\"), price: this._formatPrice( $(elem).find(\".price .money:first-child\").text() ), title: $(elem).find(\"h5 a\").text(), })) .toArray(); } ... } Here, cheerio is used to parse html text into an javascript object so that values can be easily extracted by the _parseResponse method called next in the flow. Here’s an example of that:\nexport class Scraper { ... _data: Bottle[] = []; _productLinkBase = \"\"; _scrapeId = 0; ... _buildLink(handle: string): string { return `${this._productLinkBase}${handle}`; } _parseResponse(response: any): void { if (response) { response.forEach((product: any) =\u003e { this._data.push({ link: this._buildLink(product.handle), price: product.price, scrapeId: this._scrapeId, title: product.title, website: this._website, }); }); } } ... } The scraped data is stored in memory to the _data class variable. Other class variables used here are\n_productLinkBase: Used to build the link to an individual product’s page _scrapeId: See below. The interface for the stored product data looks like this:\nexport interface Bottle { /* Link to the individual product detail page */ link: string; /* Price of the product */ price: number; /** * Unique identifier of the current scrape execution. This is used to delete * any products from the previous pull that are not present in the current * pull. */ scrapeId: number; /* Product Title */ title: string; /* Website identifier (used for filtering) */ website: string; /** * Flag to denote a product that is present in the latest scrape but * was not present in the previous scrape. */ fresh?: boolean; } Now the data is stored in memory and it just needs to be written out to the database:\nexport class Scraper { ... _storeData() { if (!this._data.length) { // Do nothing if no data could be scraped return; } /** * Execute a bulk insert operation. If a specific title/website * already exists in the database, the fields will be updated for that * document, i.e. \"upserted\". */ const bulkOp = this._db.client .db(\"bottles\") .collection(\"bottles\") .initializeUnorderedBulkOp(); this._data.forEach((d) =\u003e { bulkOp .find({ title: d.title, website: d.website, }) .upsert() .updateOne({ $set: d, /** * On insert, the `fresh` field is set to true. In order for this * to work, another step must occur prior to the scrape. I'll explain * further down the page. */ $setOnInsert: { fresh: true, }, }); }); return bulkOp.execute(); } ... } That’s enough to build a Scraper. View an example child Scraper class here.\nNow to run them in parallel using workers threads… The main index.ts file looks like this:\nimport { scrapers } from \"./scrapers\"; import { DB } from \"./db\"; import { Worker, isMainThread, workerData } from \"node:worker_threads\"; import * as cliProgress from \"cli-progress\"; async function main() { if (isMainThread) { // On the main thread, all of the child worker threads are spawned. const workers = scrapers.map((_, scraperIdx) =\u003e { return new Worker(__filename, { /** * The index is passed to the worker so that it knows * the Scraper to run */ workerData: { scraperIdx }, }); }); // A set of progress bars is displayed when running via CLI const multibar = new cliProgress.MultiBar( { clearOnComplete: false, hideCursor: true, format: \" {bar} | {filename} | {value}/{total}\", }, cliProgress.Presets.shades_grey ); // Bar progress is tracked in a key-value store const bars: { [key: string]: cliProgress.Bar } = {}; // Inialize an array to track when each worker completes its job const done = workers.map(() =\u003e false); workers.forEach((worker, idx) =\u003e { /** * Create a message listener for each worker. Workers report progress * after each page is scraped and the bars are updated here accordingly. */ worker.on( \"message\", (progress: { scraper: string; current: number; total: number }) =\u003e { if (!Object.keys(bars).includes(progress.scraper)) { bars[progress.scraper] = multibar.create(progress.total, 0, { filename: progress.scraper, }); } bars[progress.scraper].update(progress.current); if (progress.total === progress.current) { bars[progress.scraper].stop(); done[idx] = true; // When all workers are done, stop the multibar if (done.every((d) =\u003e d)) { multibar.stop(); } } } ); }); } else { // Worker threads hit this branch. new scrapers[workerData.scraperIdx]().scrape(); } } main(); The scrapers are exported in the scrapers/index.ts file.\nimport { Seelbachs } from \"./seelbachs\"; import { Sharedpour } from \"./sharedpour\"; import { Sipwhiskey } from \"./sipwhiskey\"; export const scrapers = [ Seelbachs, Sharedpour, Sipwhiskey, ]; A Few More Things The finalized scrape method looks like this:\nexport class Scraper { ... public async scrape(): Promise\u003cvoid\u003e { await this._db.connect(); await this._setScrapeId(); await this._setFreshness(); await this._scrapeAllPages(); await this._storeData(); await this._deletePreviousScrape(); this._db.client.close(); } ... } Notice there are a methods I didn’t mention before.\nThe scrapeId Every time a scraper runs, it will query the database to select a scrapeId from one of the documents. If any documents for the Scraper’s _website exist, the _scrapeId for the current scrape will 1 greater than the scrapeId of the document. Otherwise, if there are no documents, the _scrapeId for the current scrape is set to 0.\nexport class Scraper { ... async _setScrapeId() { this._scrapeId = (( await this._db.client .db(\"bottles\") .collection(\"bottles\") .findOne({ website: this._website }, { projection: { scrapeId: 1 } }) )?.scrapeId ?? -1) + 1; } ... } The upsert from the current scrape should update the scrapeId for all of the documents. After the newly scraped data is stored, any documents with the old scrapeId are deleted. This ensures that if a product was removed from the website, it is also removed from the database.\nexport class Scraper { ... _deletePreviousScrape() { return this._db.client .db(\"bottles\") .collection(\"bottles\") .deleteMany({ website: this._website, scrapeId: { $ne: this._scrapeId, }, }); } ... } Updating freshness Finally, in order to keep track of new products, a flag is added using the mongo $setOnInsert operator. However, for this to work, all of the existing documents for the current scrape need to be set to false prior to insertion.\nexport class Scraper { ... _setFreshness() { return this._db.client .db(\"bottles\") .collection(\"bottles\") .updateMany( { website: this._website, }, { $set: { fresh: false, }, } ); } ... } Conclusion All of the code described here can be found on github. In the next post, I’ll go over creating a frontend with Next.js and GraphQL.\n","wordCount":"2169","inLanguage":"en","datePublished":"2023-03-11T00:00:00Z","dateModified":"2023-03-11T00:00:00Z","author":{"@type":"Person","name":"Taylor Deckard"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.taylordeckard.me/blog/posts/bourbon/"},"publisher":{"@type":"Organization","name":"Taylor's Blog","logo":{"@type":"ImageObject","url":"https://www.taylordeckard.me/blog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.taylordeckard.me/blog accesskey=h title="Blog (Alt + H)">Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.taylordeckard.me/blog/archives title=Archives><span>Archives</span></a></li><li><a href=https://www.taylordeckard.me/blog/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://www.taylordeckard.me/blog/tags title=Tags><span>Tags</span></a></li><li><a href=https://taylordeckard.me title=taylordeckard.me><span>taylordeckard.me</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.taylordeckard.me/blog>Home</a>&nbsp;»&nbsp;<a href=https://www.taylordeckard.me/blog/posts/>Posts</a></div><h1 class=post-title>Bourbon Search pt. 1: Scraper</h1><div class=post-description>A series that discusses building a Whiskey Shop Search with Typescript, MongoDB, GraphQL and Next.js</div><div class=post-meta><span title='2023-03-11 00:00:00 +0000 UTC'>March 11, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Taylor Deckard&nbsp;|&nbsp;<a href=https://github.com/taylordeckard/blog/tree/main/content/posts/bourbon.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>Today I&rsquo;m admitting a guilty pleasure: Bourbon. I read reviews online, hunt for rare bottles, and shell out (maybe a little too much) cash sometimes on interesting things I find. Bourbon has definitely experienced a surge in popularity over the past few years, particularly in the United States. In fact, bourbon has become so popular that the industry is struggling to keep up with demand. The reasons for bourbon&rsquo;s rise in popularity are varied, but some contributing factors include the rise of the craft cocktail movement, a growing interest in American-made products, and an increased focus on artisanal and small-batch products.</p><p>One of the consequences of bourbon&rsquo;s popularity is that certain bottles have become highly sought after, and they can command high prices on the secondary market. This is particularly true for limited edition or rare bottlings, as well as bottles that have garnered high ratings from influential critics.</p><p>The high demand for these bottles has created a secondary market where collectors and enthusiasts buy and sell bottles at prices far above their retail value. In some cases, these bottles can fetch thousands of dollars, and the prices can be driven up even further by auction houses or online bidding platforms.</p><p>Some of the most sought-after bourbons include the Pappy Van Winkle line, which is produced in limited quantities and has a cult following among bourbon aficionados. Other popular bourbons include releases from Buffalo Trace&rsquo;s Antique Collection, such as the George T. Stagg and William Larue Weller bottlings. These bottles can be difficult to find at retail, and some enthusiasts are willing to pay a premium to get their hands on them.</p><p>Besides being a fan of whiskey, I&rsquo;m fascinated by the sudden and explosive growth of markets for popular items. It&rsquo;s intriguing to see how a previously niche product can become a mainstream sensation or a little-known brand can suddenly dominate the market. The study of these sudden market shifts is endlessly captivating, offering insights into the dynamism and unpredictability of consumer behavior and the economy.</p><hr><p>Thanks to <a href=https://chat.openai.com/chat>ChatGPT</a> for helping me out with the filler text above. Now let&rsquo;s talk about programming&mldr;</p><h1 id=web-scraper>Web Scraper<a hidden class=anchor aria-hidden=true href=#web-scraper>#</a></h1><p>I wanted an easier way to search for bourbon online. I have a few stores I like to browse and there are so many products that I just don&rsquo;t care about. So I made a web scraper with typescript&mldr;</p><p>I wanted to design something extensible, since I knew there were several websites I wanted to scrape. For that reason, I started with a <code>Scraper</code> base class. Generally the scraping process requires three basic steps:</p><ol><li>Scrape the total number of products you want to pull from the site.</li><li>Paginate through the entire list of products and store the product information in memory.</li><li>Save the data in a database.</li></ol><p>Incorporating this idea into the base Scraper class, I started with a simple <code>scrape</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>async</span> <span class=nx>scrape</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_scrapeAllPages</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_storeData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>I created a separate class to manage the DB connection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>MongoClient</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;mongodb&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>DB</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=nx>client</span>: <span class=kt>MongoClient</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// All credentials are set via environment variables
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB_USER</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB_PASSWORD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>host</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB_HOST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DB_PORT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=sb>`mongodb://</span><span class=si>${</span><span class=nx>user</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>password</span><span class=si>}</span><span class=sb>@</span><span class=si>${</span><span class=nx>host</span><span class=si>}</span><span class=sb>:</span><span class=si>${</span><span class=nx>port</span><span class=si>}</span><span class=sb>?retryWrites=true&amp;w=majority`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MongoClient</span><span class=p>(</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=nx>connect() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * This will return a promise that resolves after the connection
</span></span></span><span class=line><span class=cl><span class=cm>     * is made. If the client is already connected, the promise
</span></span></span><span class=line><span class=cl><span class=cm>     * immediately resolves.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Then imported it into the Scraper.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>DB</span>  <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./db&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>_db</span>: <span class=kt>DB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The scrapers will be executed in parallel, each within a worker.
</span></span></span><span class=line><span class=cl><span class=cm>     * For this reason each scraper will use a new DB class with separate   
</span></span></span><span class=line><span class=cl><span class=cm>     * connections.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_db</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DB</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>async</span> <span class=nx>scrape</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_scrapeAllPages</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_storeData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Ok, good. The database connection is in place. Now to implement step #1.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>_getTotal</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>number</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * This should return the total number products to scrape
</span></span></span><span class=line><span class=cl><span class=cm>     * from the website. This implementation will likely vary for
</span></span></span><span class=line><span class=cl><span class=cm>     * each website, so it just resolves a promise in the base class
</span></span></span><span class=line><span class=cl><span class=cm>     * and the child classes will override.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>_scrapeAllPages() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * The first step is to get the number of products to scrape
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>totalProducts</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_getTotal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Step 2 contains the bulk of the work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>_totalPages</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>_productsPerPage</span> <span class=o>=</span> <span class=mi>20</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>_website</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>_scrapeAllPages() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>totalProducts</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_getTotal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Add _totalPages and _productsPerPage as protected class variables
</span></span></span><span class=line><span class=cl><span class=cm>     * to be set by the child classes.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_totalPages</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nx>totalProducts</span> <span class=o>/</span> <span class=k>this</span><span class=p>.</span><span class=nx>_productsPerPage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>currentPage</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>currentPage</span> <span class=o>&lt;=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_totalPages</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * Since this is running in a worker, the next line reports progress
</span></span></span><span class=line><span class=cl><span class=cm>       * to the parent process.
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>parentPort</span><span class=o>?</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>current</span>: <span class=kt>currentPage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>scraper</span>: <span class=kt>this._website</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>total</span>: <span class=kt>this._totalPages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * Fetch the webpage, convert text to json, and parse the response.
</span></span></span><span class=line><span class=cl><span class=cm>       * These are methods that can be overridden by the child classes.
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_parseResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>_convertTextToJson</span><span class=p>(</span><span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_fetchUrl</span><span class=p>(</span><span class=nx>currentPage</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentPage</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Using the total number of products along with the number of products per page, the total pages are calculated. Then, each page is queried with the <code>_fetchUrl</code> method, which looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_pageKey</span> <span class=o>=</span> <span class=s2>&#34;page&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>_queryParams</span>: <span class=kt>URLSearchParams</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URLSearchParams</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>_url</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_buildUrl</span><span class=p>(</span><span class=nx>page</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Sets the &#34;page&#34; query param and adds the query params to the
</span></span></span><span class=line><span class=cl><span class=cm>     * website URL.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>queryParams</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URLSearchParams</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_queryParams</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Note: The _pageKey is used in case a site uses a different
</span></span></span><span class=line><span class=cl><span class=cm>     * name for the &#34;page&#34; param, like &#34;p&#34; for instance.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>queryParams</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_pageKey</span><span class=p>,</span> <span class=nb>String</span><span class=p>(</span><span class=nx>page</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span><span class=p>.</span><span class=nx>search</span> <span class=o>=</span> <span class=nx>queryParams</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>url</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>_fetchUrl</span><span class=p>(</span><span class=nx>page</span>: <span class=kt>number</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Call the native fetch method to get a page of data. Returns
</span></span></span><span class=line><span class=cl><span class=cm>     * text output (html) to be parsed. Child classes that query
</span></span></span><span class=line><span class=cl><span class=cm>     * an API instead of a webpage can override this method to return
</span></span></span><span class=line><span class=cl><span class=cm>     * another format such as json.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_buildUrl</span><span class=p>(</span><span class=nx>page</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>text</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>text</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The fetched page needs to be converted to json (in some cases) and parsed. The base class defines these methods to handle that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_convertTextToJson</span><span class=p>(</span><span class=nx>response</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`Failed to parse json for </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>_website</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>_parseResponse</span><span class=p>(</span><span class=nx>response</span>: <span class=kt>any</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Store products in this._data here (implemented in child class)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The above <code>_convertTextToJson</code> method will only work if the response content is in json form. One of the child classes overrides that method like this, for instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_convertTextToJson</span><span class=p>(</span><span class=nx>response</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>$</span> <span class=o>=</span> <span class=nx>cheerio</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>$</span><span class=p>(</span><span class=s2>&#34;.main_box&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>idx</span><span class=p>,</span> <span class=nx>elem</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=o>!</span><span class=nx>$</span><span class=p>(</span><span class=nx>elem</span><span class=p>).</span><span class=nx>html</span><span class=p>()</span><span class=o>?</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;sold-out&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>idx</span><span class=p>,</span> <span class=nx>elem</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>handle</span>: <span class=kt>$</span><span class=p>(</span><span class=nx>elem</span><span class=p>).</span><span class=nx>find</span><span class=p>(</span><span class=s2>&#34;h5 a&#34;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s2>&#34;href&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>price</span>: <span class=kt>this._formatPrice</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>$</span><span class=p>(</span><span class=nx>elem</span><span class=p>).</span><span class=nx>find</span><span class=p>(</span><span class=s2>&#34;.price .money:first-child&#34;</span><span class=p>).</span><span class=nx>text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span>: <span class=kt>$</span><span class=p>(</span><span class=nx>elem</span><span class=p>).</span><span class=nx>find</span><span class=p>(</span><span class=s2>&#34;h5 a&#34;</span><span class=p>).</span><span class=nx>text</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>}))</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, <a href=https://github.com/cheeriojs/cheerio>cheerio</a> is used to parse html text into an javascript object so that values can be easily extracted by the <code>_parseResponse</code> method called next in the flow. Here&rsquo;s an example of that:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_data</span>: <span class=kt>Bottle</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=nx>_productLinkBase</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>_scrapeId</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_buildLink</span><span class=p>(</span><span class=nx>handle</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>_productLinkBase</span><span class=si>}${</span><span class=nx>handle</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>_parseResponse</span><span class=p>(</span><span class=nx>response</span>: <span class=kt>any</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>response</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>product</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>_data</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>link</span>: <span class=kt>this._buildLink</span><span class=p>(</span><span class=nx>product</span><span class=p>.</span><span class=nx>handle</span><span class=p>),</span>
</span></span><span class=line><span class=cl>          <span class=nx>price</span>: <span class=kt>product.price</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>scrapeId</span>: <span class=kt>this._scrapeId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>title</span>: <span class=kt>product.title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>website</span>: <span class=kt>this._website</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The scraped data is stored in memory to the <code>_data</code> class variable. Other class variables used here are</p><ul><li><code>_productLinkBase</code>: Used to build the link to an individual product&rsquo;s page</li><li><code>_scrapeId</code>: See below.</li></ul><p>The interface for the stored product data looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>Bottle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Link to the individual product detail page */</span>
</span></span><span class=line><span class=cl>  <span class=nx>link</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Price of the product */</span>
</span></span><span class=line><span class=cl>  <span class=nx>price</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Unique identifier of the current scrape execution. This is used to delete
</span></span></span><span class=line><span class=cl><span class=cm>   * any products from the previous pull that are not present in the current
</span></span></span><span class=line><span class=cl><span class=cm>   * pull.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>scrapeId</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Product Title */</span>
</span></span><span class=line><span class=cl>  <span class=nx>title</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Website identifier (used for filtering) */</span>
</span></span><span class=line><span class=cl>  <span class=nx>website</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Flag to denote a product that is present in the latest scrape but 
</span></span></span><span class=line><span class=cl><span class=cm>   * was not present in the previous scrape. 
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>fresh?</span>: <span class=kt>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now the data is stored in memory and it just needs to be written out to the database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_storeData() {</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>_data</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// Do nothing if no data could be scraped
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Execute a bulk insert operation. If a specific title/website 
</span></span></span><span class=line><span class=cl><span class=cm>     * already exists in the database, the fields will be updated for that
</span></span></span><span class=line><span class=cl><span class=cm>     * document, i.e. &#34;upserted&#34;.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>bulkOp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>db</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>initializeUnorderedBulkOp</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_data</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>d</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bulkOp</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>find</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>title</span>: <span class=kt>d.title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>website</span>: <span class=kt>d.website</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>upsert</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>updateOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>$set</span>: <span class=kt>d</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * On insert, the `fresh` field is set to true. In order for this
</span></span></span><span class=line><span class=cl><span class=cm>           * to work, another step must occur prior to the scrape. I&#39;ll explain
</span></span></span><span class=line><span class=cl><span class=cm>           * further down the page.
</span></span></span><span class=line><span class=cl><span class=cm>           */</span> 
</span></span><span class=line><span class=cl>          <span class=nx>$setOnInsert</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fresh</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>bulkOp</span><span class=p>.</span><span class=nx>execute</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>That&rsquo;s enough to build a Scraper. View an example child Scraper class <a href=https://github.com/taylordeckard/bottle_search/blob/main/scraper/src/scrapers/cleverwine.ts>here</a>.</p><p>Now to run them in parallel using <a href=https://nodejs.org/api/worker_threads.html>workers threads&mldr;</a> The main <code>index.ts</code> file looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>scrapers</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./scrapers&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>DB</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./db&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Worker</span><span class=p>,</span> <span class=nx>isMainThread</span><span class=p>,</span> <span class=nx>workerData</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;node:worker_threads&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>cliProgress</span> <span class=kr>from</span> <span class=s2>&#34;cli-progress&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>main() {</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isMainThread</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// On the main thread, all of the child worker threads are spawned.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>workers</span> <span class=o>=</span> <span class=nx>scrapers</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>_</span><span class=p>,</span> <span class=nx>scraperIdx</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=nx>__filename</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * The index is passed to the worker so that it knows
</span></span></span><span class=line><span class=cl><span class=cm>         * the Scraper to run
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>workerData</span><span class=o>:</span> <span class=p>{</span> <span class=nx>scraperIdx</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A set of progress bars is displayed when running via CLI
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>multibar</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cliProgress</span><span class=p>.</span><span class=nx>MultiBar</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>clearOnComplete</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>hideCursor</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34; {bar} | {filename} | {value}/{total}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>cliProgress</span><span class=p>.</span><span class=nx>Presets</span><span class=p>.</span><span class=nx>shades_grey</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Bar progress is tracked in a key-value store
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>bars</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>cliProgress</span><span class=p>.</span><span class=nx>Bar</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Inialize an array to track when each worker completes its job
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>done</span> <span class=o>=</span> <span class=nx>workers</span><span class=p>.</span><span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>workers</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>worker</span><span class=p>,</span> <span class=nx>idx</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * Create a message listener for each worker. Workers report progress
</span></span></span><span class=line><span class=cl><span class=cm>       * after each page is scraped and the bars are updated here accordingly.
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>worker</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=nx>progress</span><span class=o>:</span> <span class=p>{</span> <span class=nx>scraper</span>: <span class=kt>string</span><span class=p>;</span> <span class=nx>current</span>: <span class=kt>number</span><span class=p>;</span> <span class=nx>total</span>: <span class=kt>number</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>bars</span><span class=p>).</span><span class=nx>includes</span><span class=p>(</span><span class=nx>progress</span><span class=p>.</span><span class=nx>scraper</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>bars</span><span class=p>[</span><span class=nx>progress</span><span class=p>.</span><span class=nx>scraper</span><span class=p>]</span> <span class=o>=</span> <span class=nx>multibar</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>progress</span><span class=p>.</span><span class=nx>total</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>filename</span>: <span class=kt>progress.scraper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nx>bars</span><span class=p>[</span><span class=nx>progress</span><span class=p>.</span><span class=nx>scraper</span><span class=p>].</span><span class=nx>update</span><span class=p>(</span><span class=nx>progress</span><span class=p>.</span><span class=nx>current</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>progress</span><span class=p>.</span><span class=nx>total</span> <span class=o>===</span> <span class=nx>progress</span><span class=p>.</span><span class=nx>current</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>bars</span><span class=p>[</span><span class=nx>progress</span><span class=p>.</span><span class=nx>scraper</span><span class=p>].</span><span class=nx>stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>[</span><span class=nx>idx</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// When all workers are done, stop the multibar
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nx>done</span><span class=p>.</span><span class=nx>every</span><span class=p>((</span><span class=nx>d</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>d</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>multibar</span><span class=p>.</span><span class=nx>stop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Worker threads hit this branch. 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>new</span> <span class=nx>scrapers</span><span class=p>[</span><span class=nx>workerData</span><span class=p>.</span><span class=nx>scraperIdx</span><span class=p>]().</span><span class=nx>scrape</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>main</span><span class=p>();</span>
</span></span></code></pre></div><p>The scrapers are exported in the <code>scrapers/index.ts</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Seelbachs</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./seelbachs&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Sharedpour</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./sharedpour&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Sipwhiskey</span> <span class=p>}</span> <span class=kr>from</span> <span class=s2>&#34;./sipwhiskey&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>scrapers</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=nx>Seelbachs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sharedpour</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sipwhiskey</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span></code></pre></div><h2 id=a-few-more-things>A Few More Things<a hidden class=anchor aria-hidden=true href=#a-few-more-things>#</a></h2><p>The finalized <code>scrape</code> method looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kr>public</span> <span class=kr>async</span> <span class=nx>scrape</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>void</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_setScrapeId</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_setFreshness</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_scrapeAllPages</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_storeData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_deletePreviousScrape</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Notice there are a methods I didn&rsquo;t mention before.</p><h3 id=the-scrapeid>The <code>scrapeId</code><a hidden class=anchor aria-hidden=true href=#the-scrapeid>#</a></h3><p>Every time a scraper runs, it will query the database to select a <code>scrapeId</code> from one of the documents. If any documents for the Scraper&rsquo;s <code>_website</code> exist, the <code>_scrapeId</code> for the current scrape will 1 greater than the <code>scrapeId</code> of the document. Otherwise, if there are no documents, the <code>_scrapeId</code> for the current scrape is set to 0.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>_setScrapeId() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_scrapeId</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=p>((</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>db</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> <span class=nx>website</span>: <span class=kt>this._website</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>projection</span><span class=o>:</span> <span class=p>{</span> <span class=nx>scrapeId</span>: <span class=kt>1</span> <span class=p>}</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span><span class=o>?</span><span class=p>.</span><span class=nx>scrapeId</span> <span class=o>??</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The upsert from the current scrape should update the <code>scrapeId</code> for all of the documents. After the newly scraped data is stored, any documents with the old <code>scrapeId</code> are deleted. This ensures that if a product was removed from the website, it is also removed from the database.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_deletePreviousScrape() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>db</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>deleteMany</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>website</span>: <span class=kt>this._website</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>scrapeId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>$ne</span>: <span class=kt>this._scrapeId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=updating-freshness>Updating <code>fresh</code>ness<a hidden class=anchor aria-hidden=true href=#updating-freshness>#</a></h3><p>Finally, in order to keep track of new products, a flag is added using the mongo <code>$setOnInsert</code> operator. However, for this to work, all of the existing documents for the current scrape need to be set to false prior to insertion.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Scraper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>_setFreshness() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>_db</span><span class=p>.</span><span class=nx>client</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>db</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>collection</span><span class=p>(</span><span class=s2>&#34;bottles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>updateMany</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>website</span>: <span class=kt>this._website</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>$set</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fresh</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>All of the code described here can be found <a href=https://github.com/taylordeckard/bottle_search>on github</a>. In the next post, I&rsquo;ll go over creating a frontend with Next.js and GraphQL.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.taylordeckard.me/blog/tags/programming/>programming</a></li><li><a href=https://www.taylordeckard.me/blog/tags/node.js/>node.js</a></li><li><a href=https://www.taylordeckard.me/blog/tags/typescript/>typescript</a></li><li><a href=https://www.taylordeckard.me/blog/tags/graphql/>graphql</a></li><li><a href=https://www.taylordeckard.me/blog/tags/mongodb/>mongodb</a></li><li><a href=https://www.taylordeckard.me/blog/tags/next.js/>next.js</a></li><li><a href=https://www.taylordeckard.me/blog/tags/react/>react</a></li></ul><nav class=paginav><a class=prev href=https://www.taylordeckard.me/blog/posts/distributed-dashboard/><span class=title>« Prev</span><br><span>Distributed Dashboard: Creating a Networked Client to Power Centralized Insights</span></a>
<a class=next href=https://www.taylordeckard.me/blog/posts/wordle/><span class=title>Next »</span><br><span>Wordle CLI with Node.js and TypeScript</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>